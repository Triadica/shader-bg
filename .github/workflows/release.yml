name: Build and Release

on:
  push:
    tags:
      - 'v*'  # å½“æŽ¨é€ v* æ ¼å¼çš„ tag æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ï¼‰

jobs:
  build-and-release:
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest-stable

      - name: Get version from tag
        id: get_version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: $VERSION"

      - name: Build Release
        run: |
          echo "ðŸ”¨ Starting Release build..."

          # æž„å»º Release ç‰ˆæœ¬
          xcodebuild \
            -project shader-bg.xcodeproj \
            -scheme shader-bg \
            -configuration Release \
            -derivedDataPath ./build/DerivedData \
            clean build \
            CODE_SIGN_IDENTITY="-" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

          # æŸ¥æ‰¾ç”Ÿæˆçš„ app
          APP_PATH=$(find ./build/DerivedData/Build/Products/Release -name "shader-bg.app" -type d -print -quit)

          if [ -z "$APP_PATH" ]; then
            echo "âŒ Failed to find shader-bg.app"
            exit 1
          fi

          echo "âœ… Build succeeded: $APP_PATH"
          echo "APP_PATH=$APP_PATH" >> $GITHUB_ENV

      - name: Create DMG
        run: |
          echo "ðŸ“€ Creating DMG..."

          # åˆ›å»ºä¸´æ—¶ç›®å½•
          DMG_TEMP="./dmg-temp"
          mkdir -p "$DMG_TEMP"

          # å¤åˆ¶åº”ç”¨
          cp -R "$APP_PATH" "$DMG_TEMP/"

          # åˆ›å»º Applications ç¬¦å·é“¾æŽ¥
          ln -s /Applications "$DMG_TEMP/Applications"

          # å¦‚æžœæœ‰ logoï¼Œå¤åˆ¶ä¸ºèƒŒæ™¯ï¼ˆå¯é€‰ï¼‰
          if [ -f "logo/shader-bg-logo.png" ]; then
            cp "logo/shader-bg-logo.png" "$DMG_TEMP/.background.png"
          fi

          # åˆ›å»º DMG
          DMG_NAME="shader-bg-v${{ steps.get_version.outputs.VERSION }}.dmg"
          hdiutil create \
            -volname "Shader Background" \
            -srcfolder "$DMG_TEMP" \
            -ov \
            -format UDZO \
            "$DMG_NAME"

          # æ¸…ç†
          rm -rf "$DMG_TEMP"

          # èŽ·å– DMG å¤§å°
          DMG_SIZE=$(du -sh "$DMG_NAME" | cut -f1)
          echo "âœ… DMG created: $DMG_NAME ($DMG_SIZE)"
          echo "DMG_PATH=$DMG_NAME" >> $GITHUB_ENV

      - name: Compress DMG
        run: |
          echo "ðŸ“¦ Compressing DMG..."

          # åŽ‹ç¼© DMG
          ZIP_NAME="shader-bg-v${{ steps.get_version.outputs.VERSION }}.dmg.zip"
          zip -9 "$ZIP_NAME" "$DMG_PATH"

          # èŽ·å–åŽ‹ç¼©åŽå¤§å°
          ZIP_SIZE=$(du -sh "$ZIP_NAME" | cut -f1)
          echo "âœ… Compressed: $ZIP_NAME ($ZIP_SIZE)"
          echo "ZIP_PATH=$ZIP_NAME" >> $GITHUB_ENV

      - name: Generate Release Notes
        id: release_notes
        run: |
          cat > release_notes.md << 'EOF'
          ## Shader Background v${{ steps.get_version.outputs.VERSION }}

          ### ðŸŽ¨ ç‰¹æ€§
          - 70+ ç§åŠ¨æ€è§†è§‰æ•ˆæžœ
          - å®žæ—¶æ•ˆæžœåˆ‡æ¢
          - è‡ªé€‚åº”æ€§èƒ½ä¼˜åŒ–
          - å¤šæ˜¾ç¤ºå™¨æ”¯æŒ

          ### ðŸ’» ç³»ç»Ÿè¦æ±‚
          - macOS 15.6 æˆ–æ›´é«˜ç‰ˆæœ¬
          - æ”¯æŒ Metal çš„ Mac è®¾å¤‡
          - çº¦ 3MB ç£ç›˜ç©ºé—´

          ### ðŸ“¥ å®‰è£…æ–¹æ³•

          **æ–¹å¼ä¸€ï¼šä½¿ç”¨ DMG é•œåƒï¼ˆæŽ¨èï¼‰**
          1. ä¸‹è½½ `shader-bg-v${{ steps.get_version.outputs.VERSION }}.dmg.zip`
          2. è§£åŽ‹å¾—åˆ° DMG æ–‡ä»¶
          3. åŒå‡» DMG æ–‡ä»¶æŒ‚è½½
          4. æ‹–æ”¾ shader-bg.app åˆ° Applications æ–‡ä»¶å¤¹
          5. å®Œæˆï¼ä»Žå¯åŠ¨å°æ‰“å¼€åº”ç”¨

          **æ–¹å¼äºŒï¼šç›´æŽ¥å®‰è£…**
          1. ä¸‹è½½ `shader-bg-v${{ steps.get_version.outputs.VERSION }}.dmg.zip`
          2. è§£åŽ‹å¹¶æŒ‚è½½ DMG
          3. è¿è¡Œåº”ç”¨

          ### âš ï¸ é¦–æ¬¡æ‰“å¼€
          å¦‚æžœé‡åˆ°"æ— æ³•æ‰“å¼€ï¼Œå› ä¸ºå®ƒæ¥è‡ªèº«ä»½ä¸æ˜Žçš„å¼€å‘è€…"æç¤ºï¼š

          ```bash
          # ç§»é™¤éš”ç¦»å±žæ€§
          xattr -cr /Applications/shader-bg.app
          ```

          æˆ–è€…å³é”®ç‚¹å‡»åº”ç”¨ï¼ŒæŒ‰ä½ Option é”®ï¼Œé€‰æ‹©"æ‰“å¼€"ã€‚

          ### ðŸ“ å®Œæ•´åŠŸèƒ½åˆ—è¡¨
          æŸ¥çœ‹ [README.md](https://github.com/Triadica/shader-bg/blob/main/README.md) äº†è§£æ‰€æœ‰æ•ˆæžœå’Œä½¿ç”¨æ–¹æ³•ã€‚

          ### ðŸ› é—®é¢˜åé¦ˆ
          å¦‚æœ‰é—®é¢˜ï¼Œè¯·åœ¨ [Issues](https://github.com/Triadica/shader-bg/issues) ä¸­åé¦ˆã€‚
          EOF

          echo "Release notes generated"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            ${{ env.ZIP_PATH }}
            ${{ env.DMG_PATH }}
          body_path: release_notes.md
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: shader-bg-v${{ steps.get_version.outputs.VERSION }}
          path: |
            ${{ env.DMG_PATH }}
            ${{ env.ZIP_PATH }}
          retention-days: 90
